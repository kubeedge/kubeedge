sequenceDiagram
    autonumber
    %% ========== Process 1: [Data → TelemetryDataHub → User Filters/Downloads Dataset] ==========
    participant Dev as Device
    participant Map as Mapper
    participant Edge as EdgeCore
    participant Cloud as CloudCore
    participant DC as DeviceController
    participant TMH as TelemetryMirrorHook
    participant TDH as TelemetryDataHub
    participant DB as Storage
    participant Console as DataHub Console
    participant User as User

    Dev->>Map: Generate attribute data {ns, device, property, value, ts}
    Map->>Edge: Report data
    Edge->>Cloud: Cloud-edge channel forwarding
    Cloud->>DC: Deliver device state event
    DC->>DC: Update Device CRD (main path)
    Note right of DC: Main write does not depend on any bypass components

    DC-->>TMH: Mirror event (non-blocking, asynchronous)
    TMH->>TDH: Forward {ns, device, property, value, ts, metadata}
    TDH->>DB: Persist based on ns/device/property/ts partitioning
    DB-->>TDH: Write confirmation/offset

    par User Filters and Previews
        User->>Console: Open console, select device group/time range/property
        Console->>TDH: Query selected conditions
        TDH->>DB: Scan index + pull time window data
        DB-->>TDH: Return samples/statistics (coverage, count, missing rate)
        TDH-->>Console: Preview data & quality overview
    and Export Dataset
        User->>Console: Click "Export Dataset" (CSV/Parquet/JSONL)
        Console->>TDH: Generate export task (with query conditions and format)
        TDH->>DB: Stream read/aggregate/sort (align by ts)
        TDH-->>Console: Return download link/object storage path
        Console-->>User: Provide download
    end

