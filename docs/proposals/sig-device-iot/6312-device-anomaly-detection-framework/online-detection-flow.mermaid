sequenceDiagram
    autonumber
    %% ========== Process 2: [Data → AnomalyDetector → Return Detection Results → Update CRD] ==========
    participant Dev as Device
    participant Map as Mapper
    participant Edge as EdgeCore
    participant Cloud as CloudCore
    participant DC as DeviceController
    participant DRH as DetectorRouterHook
    participant AD as AnomalyDetector (gRPC Bidirectional Stream)
    participant API as Kubernetes API Server
    participant Ev as Event/Alarm Channel

    Dev->>Map: Generate attribute data {ns, device, property, value, ts}
    Map->>Edge: Report data
    Edge->>Cloud: Cloud-edge channel forwarding
    Cloud->>DC: Deliver device state event

    DC->>API: Write/update Device CRD (reported/observed, etc.)

    rect rgb(245,245,255)
    Note right of DRH: Each DRH binds a Filter + target detector
    DC->>DRH: Pass event
    alt Meets Filter
        DRH->>AD: (If not established) Establish gRPC bidirectional stream
        DRH-->>AD: Send frame {ns, device, property, value, ts}
        AD->>AD: Model inference (load trained model/threshold)
        AD-->>DRH: Return {abnormal, type, score, reason, modelVersion}
        DRH-->>DC: Return detection result
        DC->>API: Update Device.status.anomaly field
        DC-->>Ev: Emit Kubernetes Event / Alarm (optional)
    else Does not meet Filter
        DRH->>DRH: Discard/ignore (do not route to detector)
    end
    end

    par Parallel Detectors (optional)
        DC->>DRH: Route to Detector-A (Filter condition A)
        DC->>DRH: Route to Detector-B (Filter condition B)
    end

